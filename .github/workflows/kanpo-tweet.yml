name: rss-to-twitter

on:
  workflow_dispatch:
    inputs:
      rss_url:
        description: "RSSフィードのURL"
        required: true
        default: "https://raw.githubusercontent.com/testkun08080/kanpo-rss/refs/heads/main/feed.xml"
      minutes:
        description: "何分以内に更新されたアイテムを投稿するか"
        required: true
        default: "720" # 12時間

  schedule:
    - cron: "40 23 * * *" # JST 8:40

jobs:
  check_rss:
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.check.outputs.updated }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install feedparser

      - name: Check RSS Update
        id: check
        run: |
          python scripts/check_rss.py "${{ github.event.inputs.rss_url }}" "${{ github.event.inputs.minutes }}"

      - name: Show Results
        run: |
          echo "✅ updated: ${{ steps.check.outputs.updated }}"
          echo "📝 entries:"
          echo '${{ steps.check.outputs.entries }}'

  twitter-post:
    needs: check_rss
    if: needs.check_rss.outputs.updated == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: azu/rss-to-twitter@v2
        with:
          RSS_URL: ${{ github.event.inputs.rss_url }}
          TWEET_TEMPLATE: "%desc%"
          UPDATE_WITHIN_MINUTES: ${{ github.event.inputs.minutes }}
          TWITTER_APIKEY: ${{ secrets.TWITTER_APIKEY }}
          TWITTER_APIKEY_SECRET: ${{ secrets.TWITTER_APIKEY_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}

  twitter-non-post:
    needs: check_rss
    if: needs.check_rss.outputs.updated == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: noweh/post-tweet-v2-action@v1.0
        with:
          message: "今日の現時刻では官報の更新が見つかりません。\nhttps://www.kanpo.go.jp/"
          consumer-key: ${{ secrets.TWITTER_APIKEY_SECRET }}
          consumer-secret: ${{ secrets.TWITTER_APIKEY_SECRET }}
          access-token: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          access-token-secret: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
