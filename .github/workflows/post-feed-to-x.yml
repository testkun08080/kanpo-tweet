name: Knapo Tweet Post(RSS Feed to X)

on:
  workflow_dispatch:
    inputs:
      rss_url:
        description: "RSSãƒ•ã‚£ãƒ¼ãƒ‰ã®URL"
        required: true
        default: "https://kanpo-viewer.com/feed.xml"
      rss_toc_url:
        description: "RSS_è©³ç´°ç‰ˆãƒ•ã‚£ãƒ¼ãƒ‰ã®URL"
        required: true
        default: "https://kanpo-viewer.com/feed_toc.xml"
      minutes:
        description: "ä½•åˆ†ä»¥å†…ã«æ›´æ–°ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’æŠ•ç¨¿ã™ã‚‹ã‹"
        required: true
        default: "720" # 12æ™‚é–“

  schedule:
    - cron: "33 23 * * 0-4" # æœˆæ›œã€œé‡‘æ›œã® JST 8:30 (é…å»¶ã‚’è€ƒæ…®ã—ã¦ 30åˆ†ã«è¨­å®š)ã ã„ãŸã„10åˆ†é…å»¶ã™ã‚‹

jobs:
  check_rss_and_post_feeds:
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.check_and_post.outputs.updated }}
    env:
      X_API_KEY: ${{ secrets.TWITTER_APIKEY }}
      X_API_SECRET: ${{ secrets.TWITTER_APIKEY_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
      X_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install feedparser tweepy twitter-text-parser setuptools

      - name: Check RSS and Post feed to X
        id: check_and_post
        env:
          RSS_URL: ${{ inputs.rss_url || 'https://kanpo-viewer.com/feed.xml' }}
          RSS_TOC_URL: ${{ inputs.rss_toc_url || 'https://kanpo-viewer.com/feed_toc.xml' }}
          MINUTES: ${{ inputs.minutes || '720' }}
        run: |
          echo "â–¶ï¸ RSS_URL: $RSS_URL"
          echo "â–¶ï¸ RSS_TOC_URL: $RSS_TOC_URL"  
          echo "â± MINUTES: $MINUTES"
          python scripts/check_rss_and_posting.py "$RSS_URL" "$RSS_TOC_URL" "$MINUTES"

      - name: Show Results
        run: |
          echo "âœ… updated: ${{ steps.check_and_post.outputs.updated }}"
          echo "ğŸ“ entries:"
          echo '${{ steps.check_and_post.outputs.entries }}'

  re_check_rss_and_post_feeds:
    needs: check_rss_and_post_feeds
    if: needs.check_rss_and_post_feeds.outputs.updated == 'false'
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.check_and_post.outputs.updated }}
    env:
      X_API_KEY: ${{ secrets.TWITTER_APIKEY }}
      X_API_SECRET: ${{ secrets.TWITTER_APIKEY_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
      X_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install feedparser tweepy twitter-text-parser setuptools

      - name: Check RSS and Post feed to X
        id: check_and_post
        env:
          RSS_URL: ${{ inputs.rss_url || 'https://kanpo-viewer.com/feed.xml' }}
          RSS_TOC_URL: ${{ inputs.rss_toc_url || 'https://kanpo-viewer.com/feed_toc.xml' }}
          MINUTES: ${{ inputs.minutes || '720' }}
        run: |
          echo "â–¶ï¸ RSS_URL: $RSS_URL"
          echo "â–¶ï¸ RSS_TOC_URL: $RSS_TOC_URL"  
          echo "â± MINUTES: $MINUTES"
          python scripts/check_rss_and_posting.py "$RSS_URL" "$RSS_TOC_URL" "$MINUTES"

      - name: Show Results
        run: |
          echo "âœ… updated: ${{ steps.check_and_post.outputs.updated }}"
          echo "ğŸ“ entries:"
          echo '${{ steps.check_and_post.outputs.entries }}'

  twitter-non-post:
    needs: re_check_rss_and_post_feeds
    if: needs.re_check_rss_and_post_feeds.outputs.updated == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: noweh/post-tweet-v2-action@v1.0
        with:
          message: "ç¾æ™‚åˆ»ã§ã¯å®˜å ±ã®æ›´æ–°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nhttps://www.kanpo.go.jp/"
          consumer-key: ${{ secrets.TWITTER_APIKEY }}
          consumer-secret: ${{ secrets.TWITTER_APIKEY_SECRET }}
          access-token: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          access-token-secret: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
